# Nginx configuration for EST Server with RA Certificate Authentication
#
# This configuration:
# 1. Terminates TLS on port 8445
# 2. Extracts client certificates from TLS handshake
# 3. Forwards certificate to Python EST server via HTTP headers
# 4. Enables RA certificate authentication for IQE gateway

events {
    worker_connections 1024;
}

http {
    # Upstream Python EST server (running on HTTP internally)
    upstream est_backend {
        server python-est-server:8000;
    }

    # Enable detailed logging for debugging
    log_format est_log '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'SSL_verify: $ssl_client_verify '
                       'SSL_subject: $ssl_client_s_dn';

    access_log /var/log/nginx/access.log est_log;
    error_log /var/log/nginx/error.log info;

    # EST Server with TLS and Client Certificate Support
    server {
        listen 8445 ssl;
        server_name _;

        # Server TLS certificates
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # Client certificate validation
        # CA certificate used to verify client certificates (RA certs)
        ssl_client_certificate /etc/nginx/certs/ca-cert.pem;

        # CRITICAL: Set to 'optional' to allow both:
        # - Connections WITH client cert (IQE gateway with RA cert)
        # - Connections WITHOUT client cert (direct devices with password)
        ssl_verify_client optional;
        ssl_verify_depth 2;

        # TLS protocol settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;

        # EST protocol endpoints
        location /.well-known/est/ {
            # Forward to Python EST server
            proxy_pass http://est_backend;

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;

            # CRITICAL: Forward client certificate information
            # These headers contain the client certificate data
            proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
            proxy_set_header X-SSL-Client-S-DN $ssl_client_s_dn;
            proxy_set_header X-SSL-Client-I-DN $ssl_client_i_dn;
            proxy_set_header X-SSL-Client-Serial $ssl_client_serial;
            proxy_set_header X-SSL-Client-Fingerprint $ssl_client_fingerprint;

            # Full client certificate in PEM format
            # Nginx escapes newlines - Python will need to unescape
            proxy_set_header X-SSL-Client-Cert $ssl_client_cert;

            # Timeouts (EST operations can be slow)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Disable buffering for streaming responses
            proxy_buffering off;

            # Preserve original Content-Type headers
            proxy_pass_request_headers on;
        }

        # Dashboard (no auth required)
        location / {
            proxy_pass http://est_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint - proxy to backend
        location /health {
            access_log off;
            proxy_pass http://est_backend;
            proxy_set_header Host $host;
        }

        # Nginx status (for monitoring)
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 172.0.0.0/8;  # Docker networks
            deny all;
        }
    }
}
