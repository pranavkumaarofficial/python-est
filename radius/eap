# EAP Configuration for Certificate-Based Authentication
# This enables EAP-TLS for 802.1X WiFi authentication

eap {
    # Default EAP type
    default_eap_type = tls
    timer_expire = 60
    ignore_unknown_eap_types = no
    cisco_accounting_username_bug = no
    max_sessions = ${max_requests}

    # TLS Configuration for EAP-TLS
    tls-config tls-common {
        # Server certificates (RADIUS server's own cert - generated locally on RADIUS VM)
        private_key_password = whatever
        private_key_file = /etc/freeradius/certs/server/server.key
        certificate_file = /etc/freeradius/certs/server/server.pem

        # CA Certificate - This is the EST CA that signed client certificates
        # CRITICAL: This must be your Python-EST CA certificate (copied from EST VM)
        ca_file = /etc/freeradius/certs/ca/ca-cert.pem

        # Diffie-Hellman and Elliptic Curve Diffie-Hellman parameters
        dh_file = ${certdir}/dh

        # Certificate Revocation List (optional, for now)
        # ca_path = ${cadir}
        # check_crl = yes

        # Supported TLS versions
        tls_min_version = "1.2"
        tls_max_version = "1.3"

        # Cipher suites (secure modern ciphers)
        cipher_list = "HIGH:!aNULL:!MD5:!RC4:!EXPORT"

        # Certificate validation
        check_cert_issuer = "/C=US/ST=CA/L=Test/O=Test CA/CN=Python-EST Root CA"
        check_cert_cn = %{User-Name}

        # Fragment size for TLS
        fragment_size = 1024
        include_length = yes

        # Cache configuration
        cache {
            enable = yes
            lifetime = 24  # hours
            max_entries = 255
        }

        # Verify client certificate
        verify {
            # This will check the client cert against ca_file
            tmpdir = /tmp/radiusd
            client = "/etc/freeradius/certs/ca/ca-cert.pem"
        }

        # OCSP configuration (optional - for certificate revocation checking)
        # ocsp {
        #     enable = no
        # }
    }

    # EAP-TLS Method
    tls {
        tls = tls-common

        # Require client certificate
        require_client_cert = yes

        # Include length in fragments
        include_length = yes
    }

    # EAP-TTLS (if you want to support password auth as fallback)
    ttls {
        tls = tls-common
        default_eap_type = md5
        copy_request_to_tunnel = no
        use_tunneled_reply = no
        virtual_server = "inner-tunnel"
    }

    # EAP-PEAP (if you want to support password auth as fallback)
    peap {
        tls = tls-common
        default_eap_type = mschapv2
        copy_request_to_tunnel = no
        use_tunneled_reply = no
        virtual_server = "inner-tunnel"
    }
}
